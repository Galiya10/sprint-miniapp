<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–°–ø—Ä–∏–Ω—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #1C1C1E;
      --text-main: #FFFFFF;
      --text-secondary: #8E8E93;
      --accent: #A4E34E;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg-color);
      color: var(--text-main);
      padding-bottom: 90px;
      /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä */
      padding-top: 44px; 
    }

    /* –®–ê–ü–ö–ê */
    .header {
      padding: 10px 20px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-color);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 800;
      line-height: 1.1;
    }

    .balance {
      background: #2C2C2E;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 17px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* –ö–ê–õ–ï–ù–î–ê–†–¨ */
    .calendar-wrapper {
      padding: 0 16px 24px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    
    .calendar-week {
      display: flex;
      justify-content: space-between;
      min-width: 100%;
    }

    .calendar-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      width: 44px;
    }

    .day-name {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      font-weight: 600;
    }

    .day-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      font-weight: 600;
      color: var(--text-main);
    }

    .day-number.today {
      border: 2px solid var(--accent);
      color: var(--accent);
      box-shadow: 0 0 10px rgba(164, 227, 78, 0.2);
    }

    .day-number.past { color: var(--text-secondary); }

    /* –ö–ê–†–¢–û–ß–ö–ò */
    .content { padding: 0 16px; }

    .category-title {
      font-size: 15px;
      color: var(--text-secondary);
      margin: 24px 0 12px;
      font-weight: 600;
      padding-left: 4px;
    }

    .habit-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      /* –¢–æ–Ω–∫–∞—è —Ü–≤–µ—Ç–Ω–∞—è —Ä–∞–º–∫–∞ */
      box-shadow: inset 0 0 0 1.5px var(--habit-color, #4CAF50); 
    }

    .habit-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .habit-icon-circle {
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .habit-info h3 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .habit-reward {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .check-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: transparent;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .check-btn.completed {
      background: var(--habit-color);
      color: #000;
      transform: scale(1.1);
    }

    /* –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–ò–¢–¨ */
    .add-btn {
      width: 100%;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 600;
      border: none;
      margin-top: 20px;
      cursor: pointer;
    }

    /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 0 24px;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: #636366;
      font-size: 11px;
      font-weight: 600;
      text-decoration: none;
    }

    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 22px; margin-bottom: 2px; }

    /* –§–û–†–ú–ê (–°–∫—Ä—ã—Ç–∞) */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
      display: none;
      align-items: flex-end;
    }
    
    .modal-overlay.open { display: flex; }

    .modal-sheet {
      background: #1C1C1E;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }

    input, select {
      width: 100%;
      background: #2C2C2E;
      border: none;
      padding: 16px;
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      margin-bottom: 12px;
      outline: none;
    }

    .save-btn {
      width: 100%;
      background: var(--accent);
      color: #000;
      padding: 16px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 16px;
      border: none;
      margin-top: 12px;
    }
  </style>
</head>
<body>

  <!-- –®–∞–ø–∫–∞ -->
  <div class="header">
    <h1>–°–µ–≥–æ–¥–Ω—è</h1>
    <div class="balance">
      <span id="balanceVal">0</span>
      <span style="color: #FFD700">üåº</span>
    </div>
  </div>

  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="calendar-wrapper">
    <div class="calendar-week" id="calendar"></div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ -->
  <div class="content" id="habitsList"></div>
  
  <div class="content">
    <button class="add-btn" onclick="openForm()">+ –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</button>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="bottom-nav">
    <a href="#" class="nav-item active"><span class="nav-icon">üìÖ</span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="#" class="nav-item"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="#" class="nav-item"><span class="nav-icon">‚öîÔ∏è</span>–î—É—ç–ª—å</a>
    <a href="#" class="nav-item"><span class="nav-icon">üå≥</span>–°–∞–¥</a>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div class="modal-overlay" id="formModal">
    <div class="modal-sheet">
      <h2 style="margin-bottom: 20px">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</h2>
      <input type="text" id="habitName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–µ–≥)">
      <select id="habitCategory">
        <option value="–ó–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
        <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
        <option value="–û–±—É—á–µ–Ω–∏–µ">–û–±—É—á–µ–Ω–∏–µ</option>
      </select>
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <div class="color-dot" style="background:#A4E34E; width:40px; height:40px; border-radius:50%; border:2px solid #fff" onclick="selectColor('#A4E34E', this)"></div>
        <div class="color-dot" style="background:#4EA4E3; width:40px; height:40px; border-radius:50%" onclick="selectColor('#4EA4E3', this)"></div>
        <div class="color-dot" style="background:#E34E4E; width:40px; height:40px; border-radius:50%" onclick="selectColor('#E34E4E', this)"></div>
      </div>
      <button class="save-btn" onclick="saveHabit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeForm()" style="width:100%; background:none; border:none; color:#888; padding:15px">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• "–ë–ò–¢–´–•" –î–ê–ù–ù–´–• (Undefined)
    // –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç 1 —Ä–∞–∑ –∏ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–π –º—É—Å–æ—Ä
    if (!localStorage.getItem('version_2')) {
      localStorage.clear();
      localStorage.setItem('version_2', 'true');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    let habits = JSON.parse(localStorage.getItem('habits')) || [];
    let balance = parseInt(localStorage.getItem('balance')) || 0;
    let selectedColor = '#A4E34E';

    // –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function renderCalendar() {
      const days = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
      const container = document.getElementById('calendar');
      const today = new Date();
      const currentDayIndex = (today.getDay() + 6) % 7; // –ü–ù=0
      
      let html = '';
      for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(today.getDate() - currentDayIndex + i);
        const isToday = i === currentDayIndex;
        const num = date.getDate();
        
        html += `
          <div class="calendar-day">
            <span class="day-name">${days[i]}</span>
            <div class="day-number ${isToday ? 'today' : ''} ${i < currentDayIndex ? 'past' : ''}">${num}</div>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–≤—ã—á–µ–∫
    function renderHabits() {
      const list = document.getElementById('habitsList');
      document.getElementById('balanceVal').innerText = balance;
      
      if (habits.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#555; margin-top:40px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫.<br>–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é! üëá</div>';
        return;
      }

      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
      const grouped = {};
      habits.forEach(h => {
        if (!h) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined
        if (!grouped[h.category]) grouped[h.category] = [];
        grouped[h.category].push(h);
      });

      let html = '';
      for (const cat in grouped) {
        html += `<div class="category-title">${cat}</div>`;
        grouped[cat].forEach(h => {
          const isDone = h.lastCompleted === new Date().toDateString();
          // –ò–∫–æ–Ω–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è: –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ 0 —Ä–∞–∑ - –ø—É—Å—Ç–æ, –∏–Ω–∞—á–µ —Ä–æ—Å—Ç–æ–∫/–¥–µ—Ä–µ–≤–æ
          let icon = ''; 
          if (h.streak > 5) icon = 'üå≥';
          else if (h.streak > 2) icon = 'üåø';
          else if (h.streak >= 1) icon = 'üå±';
          else icon = ''; // –ü—Ä–æ—Å—Ç–æ –ø—É—Å—Ç–æ–π –∫—Ä—É–≥

          html += `
            <div class="habit-card" style="--habit-color: ${h.color}">
              <div class="habit-left">
                <div class="habit-icon-circle">${icon}</div>
                <div class="habit-info">
                  <h3>${h.name}</h3>
                  <div class="habit-reward">+5 üåº</div>
                </div>
              </div>
              <button class="check-btn ${isDone ? 'completed' : ''}" 
                      onclick="toggleHabit(${h.id})">
                ${isDone ? '‚úì' : '‚óØ'}
              </button>
            </div>
          `;
        });
      }
      list.innerHTML = html;
    }

    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏
    window.toggleHabit = function(id) {
      const habit = habits.find(h => h.id === id);
      const today = new Date().toDateString();

      if (habit.lastCompleted !== today) {
        // –û—Ç–º–µ—á–∞–µ–º
        habit.lastCompleted = today;
        habit.streak++;
        balance += 5;
        tg.HapticFeedback.notificationOccurred('success');
      } else {
        // –°–Ω–∏–º–∞–µ–º (–µ—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –Ω–∞–∂–∞–ª–∞)
        habit.lastCompleted = null;
        habit.streak--;
        balance -= 5;
      }

      saveAndRender();
    };

    // –§–æ—Ä–º–∞
    window.openForm = () => document.getElementById('formModal').classList.add('open');
    window.closeForm = () => document.getElementById('formModal').classList.remove('open');
    
    window.selectColor = (color, el) => {
      selectedColor = color;
      document.querySelectorAll('.color-dot').forEach(d => d.style.border = 'none');
      el.style.border = '2px solid #fff';
    };

    window.saveHabit = () => {
      const name = document.getElementById('habitName').value;
      const cat = document.getElementById('habitCategory').value;
      if (!name) return;

      habits.push({
        id: Date.now(),
        name: name,
        category: cat,
        color: selectedColor,
        streak: 0,
        lastCompleted: null
      });

      closeForm();
      document.getElementById('habitName').value = '';
      saveAndRender();
    };

    function saveAndRender() {
      localStorage.setItem('habits', JSON.stringify(habits));
      localStorage.setItem('balance', balance);
      renderHabits();
    }

    // –°—Ç–∞—Ä—Ç
    renderCalendar();
    renderHabits();
  </script>
</body>
</html>
