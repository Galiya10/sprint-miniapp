<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–°–ø—Ä–∏–Ω—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #151517;
      --text-main: #FFFFFF;
      --text-secondary: #8E8E93;
      --accent: #A4E34E;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Nunito', sans-serif; }

    body {
      background: var(--bg-color);
      color: var(--text-main);
      padding-bottom: 90px;
      /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è Telegram Android */
      padding-top: 20px; 
    }
    
    /* –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    body.telegram-app {
       padding-top: 80px;
    }

    /* –®–ê–ü–ö–ê */
    .header {
      padding: 0 20px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .balance {
      background: #2C2C2E;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 17px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* –ö–ê–õ–ï–ù–î–ê–†–¨ –° –ù–ê–í–ò–ì–ê–¶–ò–ï–ô */
    .calendar-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px 24px;
    }

    .nav-arrow {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      padding: 10px;
      cursor: pointer;
    }

    .calendar-week {
      display: flex;
      justify-content: space-between;
      flex: 1;
      padding: 0 10px;
    }

    .calendar-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      position: relative;
    }

    .day-name {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 700;
      text-transform: uppercase;
    }

    .day-number {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-main);
      transition: all 0.2s;
    }

    /* –°—Ç–∏–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è */
    .calendar-day.selected .day-number {
      background: #FFFFFF;
      color: #000000;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
    }
    
    /* –°—Ç–∏–ª—å "–°–µ–≥–æ–¥–Ω—è", –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω */
    .calendar-day.is-today:not(.selected) .day-number {
      color: var(--accent);
      border: 2px solid rgba(164, 227, 78, 0.3);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∏—Å–µ–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å */
    .has-data-dot {
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
      position: absolute;
      bottom: -6px;
      display: none;
    }
    .has-data .has-data-dot { display: block; }

    /* –ö–ê–†–¢–û–ß–ö–ò */
    .content { padding: 0 16px; }

    .category-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 24px 0 12px;
      font-weight: 700;
      padding-left: 4px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .habit-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–æ–Ω–∫–∞—è –æ–±–≤–æ–¥–∫–∞ */
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      transition: transform 0.1s;
    }
    
    /* –¶–≤–µ—Ç–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç —Å–ª–µ–≤–∞ */
    .habit-card::before {
      content: '';
      position: absolute;
      left: 0; top: 18px; bottom: 18px;
      width: 4px;
      background: var(--habit-color);
      border-radius: 0 4px 4px 0;
      opacity: 0.8;
    }

    .habit-left {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-left: 8px;
    }

    .habit-icon-circle {
      width: 42px;
      height: 42px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .habit-info h3 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .habit-reward {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* –°–û–í–†–ï–ú–ï–ù–ù–ê–Ø –ì–ê–õ–û–ß–ö–ê */
    .check-btn {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .check-btn svg {
      width: 24px;
      height: 24px;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      stroke: #000;
      transform: scale(0);
      transition: transform 0.2s;
    }

    .check-btn.completed {
      background: var(--habit-color);
      border-color: var(--habit-color);
    }
    
    .check-btn.completed svg {
      transform: scale(1);
    }

    /* –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–ò–¢–¨ */
    .add-btn {
      width: 100%;
      padding: 18px;
      background: #1C1C1E;
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 700;
      border: 1px dashed rgba(255, 255, 255, 0.15);
      margin-top: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 0 30px;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #555;
      font-size: 11px;
      font-weight: 700;
      text-decoration: none;
    }

    .nav-item.active { color: #fff; }
    .nav-icon { font-size: 22px; }

    /* –§–û–†–ú–ê (–ü–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞) */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      z-index: 200;
      display: none;
      align-items: flex-end;
    }
    
    .modal-overlay.open { display: flex; }

    .modal-sheet {
      background: #1C1C1E;
      width: 100%;
      border-radius: 32px 32px 0 0;
      padding: 32px 24px 50px;
      animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }

    input, select {
      width: 100%;
      background: #2C2C2E;
      border: none;
      padding: 18px;
      border-radius: 16px;
      color: #fff;
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
      outline: none;
    }

    /* –ü–∞–ª–∏—Ç—Ä–∞ –ø–∞—Å—Ç–µ–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .color-dot {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
    }
    
    .color-dot.selected::after {
      content: '';
      position: absolute;
      top: -3px; right: -3px; bottom: -3px; left: -3px;
      border: 2px solid #fff;
      border-radius: 50%;
    }

    .save-btn {
      width: 100%;
      background: #fff;
      color: #000;
      padding: 18px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 17px;
      border: none;
      margin-top: 8px;
    }
  </style>
</head>
<body class="telegram-app">

  <!-- –®–∞–ø–∫–∞ -->
  <div class="header">
    <h1>–°–µ–≥–æ–¥–Ω—è</h1>
    <div class="balance">
      <span id="balanceVal">0</span>
      <span style="color: #FFD700">üåº</span>
    </div>
  </div>

  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="calendar-container">
    <button class="nav-arrow" onclick="changeWeek(-1)">‚Äπ</button>
    <div class="calendar-week" id="calendar"></div>
    <button class="nav-arrow" onclick="changeWeek(1)">‚Ä∫</button>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ -->
  <div class="content" id="habitsList"></div>
  
  <div class="content">
    <button class="add-btn" onclick="openForm()">
      <span>+</span> –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞
    </button>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="bottom-nav">
    <a href="#" class="nav-item active"><span class="nav-icon">üìÖ</span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="#" class="nav-item"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="#" class="nav-item"><span class="nav-icon">‚öîÔ∏è</span>–î—É—ç–ª—å</a>
    <a href="#" class="nav-item"><span class="nav-icon">üå≥</span>–°–∞–¥</a>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div class="modal-overlay" id="formModal">
    <div class="modal-sheet">
      <h2 style="margin-bottom: 24px; font-weight:800; font-size: 24px;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</h2>
      
      <input type="text" id="habitName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–µ–≥)">
      
      <select id="habitCategory">
        <option value="–ó–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
        <option value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
        <option value="–û–±—É—á–µ–Ω–∏–µ">–û–±—É—á–µ–Ω–∏–µ</option>
        <option value="–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ">–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ</option>
      </select>
      
      <label style="color:#888; font-size:13px; font-weight:700; margin-bottom:12px; display:block; text-transform:uppercase">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</label>
      
      <div class="color-grid">
        <!-- –ü–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞ -->
        <div class="color-dot" style="background:#A4E34E" onclick="selectColor('#A4E34E', this)"></div> <!-- –õ–∞–π–º -->
        <div class="color-dot" style="background:#98FB98" onclick="selectColor('#98FB98', this)"></div> <!-- –ú—è—Ç–Ω—ã–π -->
        <div class="color-dot" style="background:#87CEEB" onclick="selectColor('#87CEEB', this)"></div> <!-- –ù–µ–±–æ -->
        <div class="color-dot" style="background:#DDA0DD" onclick="selectColor('#DDA0DD', this)"></div> <!-- –°–ª–∏–≤–∞ -->
        <div class="color-dot" style="background:#FFB6C1" onclick="selectColor('#FFB6C1', this)"></div> <!-- –†–æ–∑–æ–≤—ã–π -->
        <div class="color-dot" style="background:#FFD700" onclick="selectColor('#FFD700', this)"></div> <!-- –ó–æ–ª–æ—Ç–æ -->
        <div class="color-dot" style="background:#FFA07A" onclick="selectColor('#FFA07A', this)"></div> <!-- –õ–æ—Å–æ—Å—å -->
        <div class="color-dot" style="background:#20B2AA" onclick="selectColor('#20B2AA', this)"></div> <!-- –ú–æ—Ä—Å–∫–æ–π -->
        <div class="color-dot" style="background:#B0C4DE" onclick="selectColor('#B0C4DE', this)"></div> <!-- –°—Ç–∞–ª—å -->
        <div class="color-dot" style="background:#F0E68C" onclick="selectColor('#F0E68C', this)"></div> <!-- –•–∞–∫–∏ -->
      </div>
      
      <button class="save-btn" onclick="saveHabit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeForm()" style="width:100%; background:none; border:none; color:#555; padding:15px; font-weight:600">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –û—Ç—Å—Ç—É–ø –¥–ª—è Telegram
    if (tg.platform) {
        document.body.classList.add('telegram-app');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    let habits = JSON.parse(localStorage.getItem('habits')) || [];
    let balance = parseInt(localStorage.getItem('balance')) || 0;
    let selectedColor = '#A4E34E';
    let currentWeekOffset = 0; // –°–º–µ—â–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å (0 = —Ç–µ–∫—É—â–∞—è)
    let selectedDate = new Date(); // –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)

    // –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function renderCalendar() {
      const days = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
      const container = document.getElementById('calendar');
      
      // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–µ–¥–µ–ª–∏
      const today = new Date();
      const currentDayOfWeek = (today.getDay() + 6) % 7; 
      const monday = new Date(today);
      monday.setDate(today.getDate() - currentDayOfWeek + (currentWeekOffset * 7));
      
      let html = '';
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        
        const dateString = date.toDateString();
        const isToday = date.toDateString() === new Date().toDateString();
        const isSelected = date.toDateString() === selectedDate.toDateString();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
        const hasData = habits.some(h => {
             // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–¥–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, 
             // –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º lastCompleted –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É)
             return h.lastCompleted === dateString; 
        });

        html += `
          <div class="calendar-day ${isSelected ? 'selected' : ''} ${isToday ? 'is-today' : ''} ${hasData ? 'has-data' : ''}" 
               onclick="selectDate('${date}')">
            <span class="day-name">${days[i]}</span>
            <div class="day-number">${date.getDate()}</div>
            <div class="has-data-dot"></div>
          </div>
        `;
      }
      container.innerHTML = html;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–°–µ–≥–æ–¥–Ω—è" –Ω–∞ –¥–∞—Ç—É, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ —Å–µ–≥–æ–¥–Ω—è
      const headerTitle = document.querySelector('.header h1');
      if (selectedDate.toDateString() === new Date().toDateString()) {
          headerTitle.innerText = "–°–µ–≥–æ–¥–Ω—è";
      } else {
          const options = { day: 'numeric', month: 'long' };
          headerTitle.innerText = selectedDate.toLocaleDateString('ru-RU', options);
      }
    }

    // –°–º–µ–Ω–∞ –Ω–µ–¥–µ–ª–∏
    window.changeWeek = (offset) => {
      currentWeekOffset += offset;
      renderCalendar();
    };

    // –í—ã–±–æ—Ä –¥–∞—Ç—ã
    window.selectDate = (dateStr) => {
      selectedDate = new Date(dateStr);
      renderCalendar();
      renderHabits(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
    };

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–≤—ã—á–µ–∫ (–§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –î–ê–¢–ï)
    function renderHabits() {
      const list = document.getElementById('habitsList');
      document.getElementById('balanceVal').innerText = balance;
      
      if (habits.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#333; margin-top:40px; font-weight:600">–°–∞–¥ –ø—É—Å—Ç üå±<br>–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!</div>';
        return;
      }

      const grouped = {};
      habits.forEach(h => {
        if (!h) return;
        if (!grouped[h.category]) grouped[h.category] = [];
        grouped[h.category].push(h);
      });

      let html = '';
      const viewDateStr = selectedDate.toDateString();

      for (const cat in grouped) {
        html += `<div class="category-title">${cat}</div>`;
        grouped[cat].forEach(h => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞ –≤ –í–´–ë–†–ê–ù–ù–£–Æ –¥–∞—Ç—É
          // –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Å—Å–∏–≤ –¥–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (history), –∞ –Ω–µ —Ç–æ–ª—å–∫–æ lastCompleted
          // –ù–û! –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–≤–æ—é —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É:
          // –ï—Å–ª–∏ –¥–∞—Ç–∞ == —Å–µ–≥–æ–¥–Ω—è, —Å–º–æ—Ç—Ä–∏–º lastCompleted. –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ–µ - –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –¥–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞–∂–∞—Ç—å.
          // –í –∏–¥–µ–∞–ª–µ –Ω–∞–¥–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ history: ['DateString1', 'DateString2']
          
          // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –∏—Å—Ç–æ—Ä–∏—é (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–∞ –ª–µ—Ç—É)
          if (!h.history) h.history = [];
          if (h.lastCompleted && !h.history.includes(h.lastCompleted)) h.history.push(h.lastCompleted);

          const isDone = h.history.includes(viewDateStr);
          
          let icon = ''; 
          if (h.streak > 5) icon = 'üå≥';
          else if (h.streak > 2) icon = 'üåø';
          else if (h.streak >= 1) icon = 'üå±';
          else icon = ''; 

          html += `
            <div class="habit-card" style="--habit-color: ${h.color}">
              <div class="habit-left">
                <div class="habit-icon-circle">${icon}</div>
                <div class="habit-info">
                  <h3>${h.name}</h3>
                  <div class="habit-reward">+5 üåº</div>
                </div>
              </div>
              <button class="check-btn ${isDone ? 'completed' : ''}" 
                      onclick="toggleHabit(${h.id})">
                <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
              </button>
            </div>
          `;
        });
      }
      list.innerHTML = html;
    }

    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –¥–∞—Ç)
    window.toggleHabit = function(id) {
      const habit = habits.find(h => h.id === id);
      const dateStr = selectedDate.toDateString();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç
      if (!habit.history) habit.history = [];

      if (!habit.history.includes(dateStr)) {
        // –í—ã–ø–æ–ª–Ω—è–µ–º
        habit.history.push(dateStr);
        habit.lastCompleted = dateStr; // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç—Ä–∏–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –≤—á–µ—Ä–∞
        const today = new Date();
        const diffTime = Math.abs(today - selectedDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        if (diffDays <= 2) habit.streak++;
        
        balance += 5;
        tg.HapticFeedback.notificationOccurred('success');
      } else {
        // –û—Ç–º–µ–Ω—è–µ–º
        habit.history = habit.history.filter(d => d !== dateStr);
        if (habit.streak > 0) habit.streak--;
        balance -= 5;
      }

      saveAndRender();
      renderCalendar(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
    };

    // –§–æ—Ä–º–∞
    window.openForm = () => document.getElementById('formModal').classList.add('open');
    window.closeForm = () => document.getElementById('formModal').classList.remove('open');
    
    window.selectColor = (color, el) => {
      selectedColor = color;
      document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
      el.classList.add('selected');
    };

    window.saveHabit = () => {
      const name = document.getElementById('habitName').value;
      const cat = document.getElementById('habitCategory').value;
      if (!name) return;

      habits.push({
        id: Date.now(),
        name: name,
        category: cat,
        color: selectedColor,
        streak: 0,
        lastCompleted: null,
        history: [] // –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞—Ç
      });

      closeForm();
      document.getElementById('habitName').value = '';
      saveAndRender();
    };

    function saveAndRender() {
      localStorage.setItem('habits', JSON.stringify(habits));
      localStorage.setItem('balance', balance);
      renderHabits();
    }

    // –°—Ç–∞—Ä—Ç
    renderCalendar();
    renderHabits();
  </script>
</body>
</html>
